!function(){"use strict";window.WGN=Ember.Application.create(),filepicker.setKey("AnhJmKBYSEWpXfytA3RKQz"),WGN.ref=new Firebase("https://whosgotnext.firebaseio.com/"),WGN.geoFire=new GeoFire(WGN.ref.child("_geofire")),WGN.geoFireRef=WGN.geoFire.ref(),WGN.ApplicationAdapter=DS.FirebaseAdapter.extend({firebase:WGN.ref})}(),function(){"use strict";WGN.initializer({name:"preload",initialize:function(e){var t=localStorage.getItem("firebaseToken");if(t){WGN.deferReadiness();var o=e.lookup("store:main"),r=e.lookup("controller:session");console.log(1),WGN.ref.authWithCustomToken(t,function(e,t){e?console.log("no Token!"):(console.log(2),o.find("user",t.uid).then(function(e){r.set("currentUser",e),console.log(3),WGN.advanceReadiness()}))})}}})}(),function(){"use strict";WGN.Router.map(function(){this.route("index",{path:"/"}),this.route("welcome",{path:"/welcome"}),this.route("editProfile",{path:"/editProfile"}),this.resource("courts",function(){this.route("profile",{path:":court_id"})})}),WGN.IndexRoute=Ember.Route.extend({}),WGN.EditProfileRoute=Ember.Route.extend({model:function(){return this.store.find("user",this.controllerFor("session").get("currentUser").id)},setupController:function(e,t){this._super(e,t),e.set("avatarUrl",null)}}),WGN.CourtsRoute=Ember.Route.extend({model:function(){return this.store.find("court")}}),WGN.CourtsProfileRoute=Ember.Route.extend({model:function(e){return this.store.find("court",e.court_id)}})}(),function(){"use strict";WGN.User=DS.Model.extend({handle:DS.attr("string"),email:DS.attr("string"),password:DS.attr("string"),alleyOopdates:DS.hasMany("alleyOopdate",{async:!0}),avatarUrl:DS.attr("string"),courts:DS.hasMany("court"),latitude:DS.attr("number"),longitude:DS.attr("number"),location:function(){return this.getProperties("latitude","longitude")}.property("latitude","longitude"),courtPhotos:DS.hasMany("courtPhoto",{async:!0}),courtVines:DS.hasMany("courtVine",{async:!0})})}(),function(){"use strict";WGN.Court=DS.Model.extend({name:DS.attr("string"),address:DS.attr("string"),latitude:DS.attr("number"),longitude:DS.attr("number"),location:function(){return this.getProperties("latitude","longitude")}.property("latitude","longitude"),alleyOopdates:DS.hasMany("alleyOopdate",{async:!0}),whenClosed:DS.attr("string"),otherNotes:DS.attr("string"),courtVisuals:DS.hasMany("courtVisual",{embedded:!0}),courtPhotos:DS.hasMany("courtPhoto",{async:!0}),courtVines:DS.hasMany("courtVine",{async:!0})})}(),function(){"use strict";WGN.AlleyOopdate=DS.Model.extend({user:DS.belongsTo("user",{async:!0}),court:DS.belongsTo("court"),verifiedAtCourt:DS.attr("boolean"),numberPeeps:DS.attr("string"),arrivalTime:DS.attr("string"),departureGuess:DS.attr("string"),convoyQty:DS.attr("string"),alleyOopdateText:DS.attr("string"),timestamp:DS.attr("date"),displayDate:function(){return moment(this.get("timestamp")).format("Do MMMM YYYY - h:mm A")}.property("timestamp")})}(),function(){"use strict";WGN.CourtVisual=DS.Model.extend({user:DS.belongsTo("user"),court:DS.belongsTo("court"),type:DS.attr("string"),content:DS.attr("string"),photo:DS.attr("boolean"),vine:DS.attr("boolean")})}(),function(){"use strict";WGN.CourtPhoto=DS.Model.extend({user:DS.belongsTo("user"),court:DS.belongsTo("court"),content:DS.attr("string")})}(),function(){"use strict";WGN.CourtVine=DS.Model.extend({user:DS.belongsTo("user"),court:DS.belongsTo("court"),content:DS.attr("string")})}(),function(){"use strict";WGN.SessionController=Ember.Controller.extend({currentUser:null,userCoords:null})}(),function(){"use strict";WGN.ApplicationController=Ember.Controller.extend({needs:["session"],currentUser:Ember.computed.alias("controllers.session.currentUser"),actions:{signOut:function(){WGN.ref.unauth(),console.log("Trying to sign you out..."),localStorage.removeItem("firebaseToken"),this.set("controllers.session.currentUser",null),this.transitionToRoute("index")}}})}(),function(){"use strict";WGN.IndexController=Ember.Controller.extend({needs:["session"],actions:{createUser:function(){var e=this.getProperties("emailNU","passwordNU"),t={email:e.emailNU,password:e.passwordNU},o=this,r=this.get("handleNU");return new Ember.RSVP.Promise(function(e){WGN.ref.createUser(t,function(s){s?console.log("error!"):WGN.ref.authWithPassword(t,function(s,n){var i=o.store.createRecord("user",{id:n.uid,email:t.email,handle:r});i.save(),localStorage.setItem("firebaseToken",n.token),o.set("controllers.session.currentUser",i),o.set("emailNU",""),o.set("passwordNU",""),o.set("handleNU",""),e(n),o.transitionToRoute("welcome")})})})},signIn:function(){var e=this.getProperties("email","password"),t=this;return new Ember.RSVP.Promise(function(o){WGN.ref.authWithPassword(e,function(e,r){e?console.log("error!"):t.store.find("user",r.uid).then(function(e){localStorage.setItem("firebaseToken",r.token),t.set("controllers.session.currentUser",e),t.set("email",""),t.set("password",""),o(r),t.transitionToRoute("courts")})})})}}})}(),function(){"use strict";WGN.WelcomeController=Ember.Controller.extend({actions:{proceedToCourts:function(){this.transitionToRoute("courts")}}})}(),function(){"use strict";WGN.EditProfileController=Ember.Controller.extend({avatarToUpload:null,actions:{addAvatar:function(){var e=this;filepicker.pickAndStore({mimetype:"image/*"},{},function(t){var o=t[0].url;e.set("avatarToUpload",o)})},updateProfile:function(){var e=this;e.get("avatarToUpload")&&this.model.set("avatarUrl",e.get("avatarToUpload")),this.model.save(),e.set("avatarToUpload",null),this.transitionToRoute("courts")},doNotUpdate:function(){var e=this;e.set("avatarToUpload",null),this.transitionToRoute("courts")}}})}(),function(){"use strict";WGN.CourtsController=Ember.ArrayController.extend({needs:["session","courtsProfile"],currentUser:Ember.computed.alias("controllers.session.currentUser"),isAddingCourt:!1,searchCoords:null,sortAscending:!0,sortProperties:["name"],courtFilter:"",filteredContent:function(){var e=new RegExp(this.get("courtFilter").toLowerCase());return this.get("arrangedContent").filter(function(t){return e.test(t.get("name").toLowerCase())})}.property("courtFilter","model.@each"),actions:{updateQueryLocation:function(){var e=this.get("newSearchLocation");e=e.replace(/\s+/g,"+");var t=this;$.getJSON("https://maps.googleapis.com/maps/api/geocode/json?address="+e+"&key=AIzaSyCL3fbgwq4b6nGdezKibSCXF5SfvKJQ-IM",function(){}).then(function(e){var o=e.results[0].geometry.location.lat,r=e.results[0].geometry.location.lng;t.set("searchCoords",[o,r])})},drawCourt:function(){this.set("isAddingCourt",!0)},submitCourt:function(){var e=this,t=this.get("courtName"),o=this.get("whenClosed"),r=this.get("otherNotes"),s=this.get("newAddress"),n=s.replace(/\s+/g,"+");$.getJSON("https://maps.googleapis.com/maps/api/geocode/json?address="+n+"&key=AIzaSyCL3fbgwq4b6nGdezKibSCXF5SfvKJQ-IM",function(){}).then(function(n){var i=n.results[0].geometry.location.lat,a=n.results[0].geometry.location.lng,l=e.store.createRecord("court",{name:t,address:s,latitude:i,longitude:a,whenClosed:o,otherNotes:r});l.save().then(function(){WGN.geoFire.set("court:"+l.get("id"),[i,a]).then(function(){console.log("Provided key has been added to GeoFire")},function(e){console.log("Error: "+e)})})}),this.set("courtName",""),this.set("whenClosed",""),this.set("otherNotes",""),this.set("newAddress",""),this.set("isAddingCourt",!1)},cancelSubmit:function(){this.set("isAddingCourt",!1)}}})}(),function(){"use strict";WGN.CourtsProfileController=Ember.ObjectController.extend({needs:["session","courts"],isPosting:!1,isVerified:!1,isEditingCourt:!1,photos:Ember.computed.filterBy("model.courtVisuals","type","photo"),oopdatesSorting:["timestamp:desc"],sortedOopdates:Ember.computed.sort("alleyOopdates","oopdatesSorting"),Haversine:function(){Number.prototype.toRad=function(){return this*Math.PI/180};var e=42.741,t=-71.3161,o=42.806911,r=-71.290611;o=this.get("model.latitude"),r=this.get("model.longitude"),e=+localStorage.getItem("userCoords.lat"),t=+localStorage.getItem("userCoords.lon"),console.log(localStorage),console.log(localStorage.getItem("userCoords.lat")),console.log(localStorage.getItem("userCoords.lon"));var s=6371,n=e-o,i=n.toRad(),a=t-r,l=a.toRad(),u=Math.sin(i/2)*Math.sin(i/2)+Math.cos(o.toRad())*Math.cos(e.toRad())*Math.sin(l/2)*Math.sin(l/2),c=2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)),d=s*c;return console.log(d),d},actions:{addAlleyOopdate:function(){this.set("isPosting",!0);var e=this.Haversine();console.log(e),1>=e?(this.set("isVerified",!0),alert("VERIFIED: at the court!")):this.set("isVerified",!1)},postAlleyOopdate:function(){var e=this.get("numberPeeps"),t=this.get("arrivalTime"),o=this.get("departureGuess"),r=this.get("alleyOopdateText"),s=this.get("convoyQty"),n=this.store.createRecord("alleyOopdate",{user:this.get("controllers.session.currentUser"),court:this.model,verifiedAtCourt:this.get("isVerified"),numberPeeps:e,arrivalTime:t,departureGuess:o,convoyQty:s,alleyOopdateText:r,timestamp:new Date});this.get("model.alleyOopdates").addObject(n),n.save(),this.get("model").save(),this.set("isPosting",!1)},cancelAlleyOopdate:function(){this.set("isPosting",!1)},editCourt:function(){this.set("isEditingCourt",!0),console.log("true",this.model)},updateCourt:function(){var e=this,t=this.get("name"),o=this.get("whenClosed"),r=this.get("otherNotes"),s=this.get("address"),n=s.replace(/\s+/g,"+");$.getJSON("https://maps.googleapis.com/maps/api/geocode/json?address="+n+"&key=AIzaSyCL3fbgwq4b6nGdezKibSCXF5SfvKJQ-IM",function(){}).then(function(n){var i=n.results[0].geometry.location.lat,a=n.results[0].geometry.location.lng;e.store.find("court",e.model.id).then(function(n){var l={id:e.model.id,name:t,whenClosed:o,otherNotes:r,address:s,latitude:i,longitude:a};e.store.update("court",l),n.save()})}),this.set("isEditingCourt",!1)},cancelCourtProfileUpdate:function(){this.set("isEditingCourt",!1),this.get("model").rollback()},pickPhotoToUpload:function(){filepicker.setKey("AtsLXZDyQjqLWfPEzKhfAz");var e=this;filepicker.pickAndStore({mimetype:"image/*"},{},function(t){var o=t[0].url;e.set("newCourtPhoto",o),console.log(e.get("newCourtPhoto"))})},uploadPhoto:function(){var e=this,t=this.store.createRecord("courtPhoto",{user:e.get("controllers.session.currentUser"),court:e.model,content:e.get("newCourtPhoto")});this.get("model.courtPhotos").addObject(t),t.save(),this.model.save(),this.set("newCourtPhoto","")},cancelUploadPhoto:function(){this.set("newCourtPhoto","")},enterVineUrl:function(){var e=this.get("newVineUrl"),t=this.store.createRecord("courtVine",{user:this.get("controllers.session.currentUser"),court:this.model,content:e+"/embed/simple?audio=1"});this.get("model.courtVines").addObject(t),t.save(),this.model.save(),this.set("newVineUrl","")}}})}(),function(){"use strict";WGN.CourtsView=Ember.View.extend({mapListeners:[],didInsertElement:function(){this._super(),this.getUserCoords()},userCoords:[],coordsInUse:[],radiusInKm:8,getUserCoords:function(){var e=this;navigator.geolocation.getCurrentPosition(function(t){var o=t.coords.latitude,r=t.coords.longitude,s=[o,r];e.set("userCoords",s),e.set("coordsInUse",s),localStorage.setItem("userCoords.lat",o),localStorage.setItem("userCoords.lon",r),e.initializeGQ(),e.initializeMap()})},initializeGQ:function(){var e=this.get("coordsInUse"),t=this.get("radiusInKm");this.set("courtsInQuery",{});var o=WGN.geoFire.query({center:e,radius:t});this.set("geoQuery",o),o.on("key_entered",this.addCourtToMap.bind(this)),o.on("key_exited",this.removeCourtFromMap.bind(this))},initializeMap:function(){var e,t=this.get("coordsInUse"),o=this.get("radiusInKm"),r=new google.maps.LatLng(t[0],t[1]);e=new google.maps.Map(document.getElementById("pinnedMap"),{center:r,zoom:12,mapTypeId:google.maps.MapTypeId.ROADMAP}),this.set("map",e);var s=new google.maps.Circle({strokeColor:"#6D3099",strokeOpacity:.7,strokeWeight:1,fillColor:"#B650FF",fillOpacity:.35,map:e,center:r,radius:1e3*o,draggable:!0});this.set("circle",s);var n=google.maps.event.addListener(s,"drag",this.updateCriteria.bind(this));this.get("mapListeners").push(n)},updateCriteria:_.debounce(function(){var e=this.get("circle"),t=e.getCenter();this.get("geoQuery").updateCriteria({center:[t.lat(),t.lng()],radius:this.get("radiusInKm")})},10),addCourtToMap:function(e){var t=this,o=this.get("courtsInQuery");e=e.split(":")[1],o[e]=!0,WGN.ref.child("courts").child(e).once("value",function(r){var s=r.val();s.id=e,null!==s&&o[e]===!0&&(o[e]=s,s.marker=t.createCourtMarker(s))})},removeCourtFromMap:function(e){e=e.split(":")[1];var t=this.get("courtsInQuery"),o=t[e];o!==!0&&o.marker.setMap(null),delete t[e]},createCourtMarker:function(e){var t=this.get("map"),o=new google.maps.Marker({icon:"images/basketball56.png",position:new google.maps.LatLng(e.latitude,e.longitude),optimized:!0,map:t,clickable:!0}),r=this,s=google.maps.event.addListener(o,"click",function(){r.get("controller").transitionToRoute("/courts/"+e.id)});return this.get("mapListeners").push(s),o},updateMapCenter:function(){var e=this.get("map"),t=this.get("coordsInUse"),o=new google.maps.LatLng(t[0],t[1]);e.setCenter(o);var r=this.get("circle");r.setCenter(o)},willDestroyElement:function(){this.get("mapListeners").forEach(function(e){google.maps.event.removeListener(e)}),this.set("mapListeners",[]),this.geoQuery.cancel(),this.set("map",null),this.set("controller.searchCoords",null)},searchQueryChanged:function(){var e=this.get("controller.searchCoords");e&&(this.set("coordsInUse",e),this.updateMapCenter(),this.updateCriteria())}.observes("controller.searchCoords")})}();